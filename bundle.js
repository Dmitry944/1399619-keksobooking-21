(()=>{"use strict";window.consts={TYPES:{palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},OFFSET_X:25,OFFSET_Y:70,ENTER_KEY:"Enter",ESC_KEY:"Escape",MAIN_PIN_ARROW:16,MIN_TITLE_LENGTH:30,MAX_TITLE_LENGTH:100,MAX_PRICE:1e6,MAX_PINS:5,DEBOUNCE_INTERVAL:500,LOW_PRICE:1e4,HIGH_PRICE:5e4},(()=>{const e=document.querySelector("main"),t=document.querySelector(".map"),n=document.querySelector(".map__pins"),o=document.querySelector(".map__pin--main"),r=document.querySelector(".ad-form"),i=r.querySelectorAll(".ad-form__element, .ad-form-header"),s=r.querySelector("#address"),a=r.querySelector("#title"),c=r.querySelector("#type"),d=r.querySelector("#price"),l=r.querySelector("#room_number"),u=r.querySelector("#capacity"),m=r.querySelector("#timein"),p=r.querySelector("#timeout"),f=r.querySelector("#avatar"),w=r.querySelector("#images"),y=document.querySelector(".map__filters"),v=y.querySelector("#housing-type"),_=y.querySelector("#housing-price"),E=y.querySelector("#housing-rooms"),g=y.querySelector("#housing-guests"),h=document.querySelector(".map__filters-container"),L=h.querySelectorAll(".map__filter, .map__features"),S=document.querySelector("#success"),q=document.querySelector("#error"),F=r.querySelector(".ad-form__reset");window.elements={main:e,map:t,mapPins:n,mapPinMain:o,adForm:r,adFormElements:i,addressForm:s,titleForm:a,typeForm:c,priceForm:d,roomNumberForm:l,capacityForm:u,timeInForm:m,timeOutForm:p,avatarInputForm:f,imagesInputForm:w,mapFilters:h,mapFiltersElements:L,successMessage:S,errorMessage:q,adFormReset:F,mapFiltersForm:y,typeFilter:v,priceFilter:_,roomsFilter:E,guestsFilter:g}})(),(()=>{const e=window.consts.DEBOUNCE_INTERVAL;window.debounce=function(t){let n=null;return function(...o){n&&window.clearTimeout(n),n=window.setTimeout((function(){t(...o)}),e)}}})(),(()=>{const e=window.consts.MAX_PINS,t="https://21.javascript.pages.academy/keksobooking/data",n="https://21.javascript.pages.academy/keksobooking",o="GET",r="POST";window.load={load:function(n,r){const i=new XMLHttpRequest;i.responseType="json",i.timeout=1e4,i.addEventListener("load",(function(){200===i.status?(window.offers=i.response,window.sortedOffers=i.response.slice(0,e),n(window.sortedOffers)):r(`Статус ответа: ${i.status} ${i.statusText}`)})),i.addEventListener("error",(function(){r("Произошла ошибка соединения")})),i.addEventListener("timeout",(function(){r(`Запрос не успел выполниться за ${i.timeout} мс`)})),i.open(o,t),i.send()},upload:function(e,t,o){const i=new XMLHttpRequest;i.responseType="json",i.addEventListener("load",(function(){200===i.status?t():o()})),i.addEventListener("error",(function(){o()})),i.addEventListener("timeout",(function(){o()})),i.open(r,n),i.send(e)}}})(),window.utils={getRandomInt:function(e){return Math.floor(Math.random()*Math.floor(e))},getRandomIntInclusive:function(e,t){const n=Math.ceil(e),o=Math.floor(t);return Math.floor(Math.random()*(o-n+1))+n},removeAttribute:function(e,t){for(let n=0;n<e.length;n++)e[n].removeAttribute(t)},addAttribute:function(e,t){for(let n=0;n<e.length;n++)e[n].setAttribute(t,"")}},(()=>{const e=window.consts.MAIN_PIN_ARROW,t=window.consts.MIN_TITLE_LENGTH,n=window.consts.MAX_TITLE_LENGTH,o=window.consts.MAX_PRICE,r=window.consts.ESC_KEY,i=window.elements.main,s=window.elements.adForm,a=window.elements.addressForm,c=window.elements.titleForm,d=window.elements.priceForm,l=window.elements.roomNumberForm,u=window.elements.capacityForm,m=window.elements.timeInForm,p=window.elements.timeOutForm,f=window.elements.avatarInputForm,w=window.elements.imagesInputForm,y=window.elements.typeForm,v=window.elements.mapPinMain,_=window.elements.successMessage,E=window.elements.errorMessage;let g="flat";const h={bungalow:0,flat:1e3,house:5e3,palace:1e4};let L="1";const S={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},q={1:"Только на одного гостя",2:"Только на одного или двух гостей",3:"Только на одного, двух или трех гостей",100:"Только не для гостей"};function F(e){const t=e.value;e.validity.valueMissing?e.setCustomValidity("Поле обязательно для заполнения"):t<h[g]?e.setCustomValidity("Минимальная цена "+h[g]):t>o?e.setCustomValidity("Максимальная цена "+o):e.setCustomValidity(""),e.reportValidity()}function C(e){const t=e.value;S[L].some((function(e){return e===t}))?e.setCustomValidity(""):e.setCustomValidity(q[L]),e.reportValidity()}function M(e){e.preventDefault();const t=i.querySelector(".success");document.removeEventListener("click",M),document.removeEventListener("keydown",b),i.removeChild(t)}function b(e){e.key===r&&M(e)}function k(e){e.preventDefault();const t=i.querySelector(".success"),n=t.querySelector(".error__button");document.removeEventListener("click",k),document.removeEventListener("keydown",T),n.removeEventListener("click",k),i.removeChild(t)}function T(e){e.key===r&&k(e)}a.setAttribute("readonly",""),c.setAttribute("required",""),d.setAttribute("required",""),f.setAttribute("accept","image/*"),w.setAttribute("accept","image/*"),s.action="https://21.javascript.pages.academy/keksobooking",c.addEventListener("input",(function(e){const o=e.target.value.length;e.target.validity.valueMissing?e.target.setCustomValidity("Поле обязательно для заполнения"):o<t?e.target.setCustomValidity(`Ещё ${t-o} символов`):o>n?e.target.setCustomValidity(`Необходимо уменьшить на ${o-n} символов`):e.target.setCustomValidity(""),e.target.reportValidity()})),d.placeholder=h[g],d.addEventListener("input",(function(e){F(e.target)})),y.addEventListener("change",(function(e){g=e.target.value,d.placeholder=h[e.target.value],F(d)})),l.addEventListener("change",(function(e){L=e.target.value,C(u)})),u.addEventListener("change",(function(e){C(e.target)})),m.addEventListener("change",(function(e){p.value=e.target.value})),p.addEventListener("change",(function(e){m.value=e.target.value})),window.form={setAddress:function(t){const n=v.offsetLeft,o=v.offsetTop,r=v.clientWidth,i=v.clientHeight,s=Math.round(n+r/2),c=t?Math.round(o+e+i):Math.round(o+i/2);a.value=`${s}, ${c}`},showSuccessMessage:function(){const e=_.content.cloneNode(!0);document.addEventListener("click",M),document.addEventListener("keydown",b),i.appendChild(e)},showErrorMessage:function(){const e=E.content.cloneNode(!0),t=e.querySelector(".error__button");document.addEventListener("click",k),document.addEventListener("keydown",T),t.addEventListener("click",k),i.appendChild(e)}}})(),(()=>{const e=window.consts.OFFSET_Y,t=window.consts.OFFSET_X,n=document.querySelector("#pin");window.pin={createPinElement:function(o,r){const i=n.content.cloneNode(!0),s=i.querySelector(".map__pin");s.dataset.id=r,s.style.cssText=`left: ${o.location.x-t}px; top: ${o.location.y-e}px;`;const a=s.querySelector("img");return a.alt=o.offer.title,a.src=o.author.avatar,i}}})(),(()=>{const e=window.consts.TYPES,t=document.querySelector("#card");window.card={createCardElement:function(n){const o=t.content.cloneNode(!0),r=o.querySelector(".popup__title"),i=o.querySelector(".popup__text--address"),s=o.querySelector(".popup__text--price"),a=o.querySelector(".popup__type"),c=o.querySelector(".popup__text--capacity"),d=o.querySelector(".popup__text--time"),l=o.querySelector(".popup__features"),u=o.querySelector(".popup__description"),m=o.querySelector(".popup__photos"),p=o.querySelector(".popup__avatar");r.textContent=n.offer.title,i.textContent=n.offer.address,s.textContent=n.offer.price+"₽/ночь",a.textContent=e[n.offer.type],c.textContent=`${n.offer.rooms} комнаты для ${n.offer.guests} гостей`,d.textContent=`Заезд после ${n.offer.checkin}, выезд до ${n.offer.checkout}`,u.textContent=n.offer.description,p.src=n.author.avatar,l.innerHTML="";for(let e=0;e<n.offer.features.length;e++){const t=document.createElement("li");t.classList.add("popup__feature","popup__feature--"+n.offer.features[e]),l.appendChild(t)}m.innerHTML="";for(let e=0;e<n.offer.photos.length;e++){const t=document.createElement("img");t.classList.add("popup__photo"),t.width=45,t.height=40,t.alt="Фотография жилья",t.src=n.offer.photos[e],m.appendChild(t)}return o}}})(),(()=>{const e=window.consts.ESC_KEY,t=window.consts.MAIN_PIN_ARROW,n=window.elements.map,o=window.elements.mapPins,r=window.elements.mapPinMain,i=window.elements.mapFilters,s=window.card.createCardElement,a=window.form.setAddress,c=0,d=n.offsetWidth,l=130,u=630;function m(e){e.querySelector(".popup__close").addEventListener("click",p),document.addEventListener("keydown",f),n.insertBefore(e,i)}function p(){const e=n.querySelector(".map__card"),t=n.querySelector(".map__pin--active");e&&(e.querySelector(".popup__close").removeEventListener("click",p),document.removeEventListener("keydown",f),e.remove()),t&&t.classList.remove("map__pin--active")}function f(t){t.key===e&&(t.preventDefault(),p())}window.map={appendPins:function(e){const t=document.createDocumentFragment();for(let n=0;n<e.length;n++)t.appendChild(window.pin.createPinElement(e[n],n));o.appendChild(t)},pinClickHandler:function(e){e.target.classList.contains("map__pin")&&!e.target.classList.contains("map__pin--main")?(p(),m(s(window.sortedOffers[e.target.dataset.id])),e.target.classList.add("map__pin--active")):e.target.parentElement.classList.contains("map__pin")&&!e.target.parentElement.classList.contains("map__pin--main")&&(p(),m(s(window.sortedOffers[e.target.parentElement.dataset.id])),e.target.parentElement.classList.add("map__pin--active"))},mainPinMove:function(e){e.preventDefault();let n={x:e.clientX,y:e.clientY};const o=function(e){e.preventDefault();const o=n.x-e.clientX,i=n.y-e.clientY;n={x:e.clientX,y:e.clientY},r.style.top=r.offsetTop-i+"px",r.style.left=r.offsetLeft-o+"px",r.offsetLeft<c-r.offsetWidth/2?r.style.left=c-r.offsetWidth/2+"px":r.offsetLeft>d-r.offsetWidth/2&&(r.style.left=d-r.offsetWidth/2+"px"),r.offsetTop<l-r.offsetHeight-t?r.style.top=l-r.offsetHeight-t+"px":r.offsetTop>u-r.offsetHeight-t&&(r.style.top=u-r.offsetHeight-t+"px"),a(!0)},i=function(e){e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",i)},closeCard:p,removePins:function(){n.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((function(e){e.remove()}))}}})(),(()=>{const e=window.consts.ENTER_KEY,t=window.elements.map,n=window.elements.mapPinMain,o=window.elements.adForm,r=window.elements.adFormElements,i=window.elements.mapFiltersElements,s=window.form.setAddress,a=window.utils.addAttribute,c=window.utils.removeAttribute,d=window.map.mainPinMove,l=window.load.load,u=window.map.appendPins,m=window.map.removePins;function p(a){0!==a.button&&a.key!==e||(a.preventDefault(),l(u,f),t.classList.remove("map--faded"),o.classList.remove("ad-form--disabled"),c(r,"disabled"),c(i,"disabled"),n.removeEventListener("mousedown",p),n.removeEventListener("keydown",p),s(!0),n.addEventListener("mousedown",d))}const f=e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: #f0f0ea; vertical-align: middle",t.style.position="absolute",t.style.width="80%",t.style.left=0,t.style.right=0,t.style.top="30px",t.style.fontSize="30px",t.textContent=e+".\n    Укажите местоположение вашего объявления без соседних",document.body.insertAdjacentElement("afterbegin",t)};window.activatePage={disablePage:function(){t.classList.add("map--faded"),o.classList.add("ad-form--disabled"),a(r,"disabled"),a(i,"disabled"),m();const e=document.querySelector(".map__card");e&&e.remove(),s(!1),n.addEventListener("mousedown",p),n.addEventListener("keydown",p)}}})(),(()=>{const e=window.consts.MAX_PINS,t=window.consts.LOW_PRICE,n=window.consts.HIGH_PRICE,o=window.elements.mapFiltersForm,r=window.elements.typeFilter,i=window.elements.priceFilter,s=window.elements.roomsFilter,a=window.elements.guestsFilter,c=window.map.appendPins,d=window.map.removePins,l=window.map.closeCard,u=window.debounce(c);o.addEventListener("change",(function(){d(),l(),u(function(t){const n=t.slice(0,e);return window.sortedOffers=n,n}(window.offers.filter((function(e){return function(e){return"any"===r.value||e.offer.type===r.value}(e)&&function(e){const o=e.offer.price;switch(i.value){case"low":return o<t;case"middle":return o>=t&&o<=n;case"high":return o>n;default:return!0}}(e)&&function(e){return"any"===s.value||e.offer.rooms.toString()===s.value}(e)&&function(e){return"any"===a.value||e.offer.guests.toString()===a.value}(e)&&function(e){let t=document.querySelectorAll(".map__checkbox:checked");return Array.from(t).every((function(t){return e.offer.features.indexOf(t.value)>=0}))}(e)}))))}))})(),(()=>{const e=window.elements.map,t=window.form.showSuccessMessage,n=window.form.showErrorMessage,o=window.activatePage.disablePage,r=window.load.upload,i=window.elements.adForm,s=window.elements.adFormReset;o(),e.addEventListener("click",window.map.pinClickHandler),s.addEventListener("click",o),i.addEventListener("submit",(function(e){e.preventDefault(),r(new FormData(i),(function(){i.reset(),o(),t()}),n)}))})()})();